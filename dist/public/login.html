<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link href="/css/style.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
        <style>
            .gradient-bg { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); }
            .card { background: #ffffff; border: 1px solid #e5e7eb; }
            .input { border: 1px solid #d1d5db; }
            .input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.2); }
            .btn-primary { background: #4f46e5; color: white; }
            .btn-primary:hover { background: #4338ca; }
        </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-white">Sign in</h1>
            <p class="text-gray-300">Use your email to receive a login code</p>
        </div>
        <div class="card rounded-xl p-6 shadow-md">
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input id="email" name="email" type="email" required class="input mt-1 block w-full rounded-md px-3 py-2" placeholder="you@example.com" />
                </div>
                <div id="codeWrap" class="hidden">
                    <label for="otp" class="block text-sm font-medium text-gray-700">Verification code</label>
                    <input id="otp" name="otp" type="text" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" class="input mt-1 block w-full rounded-md px-3 py-2" placeholder="6-digit code" />
                </div>
                <div class="flex gap-2">
                    <button type="submit" id="sendBtn" class="btn-primary flex-1 rounded-md px-4 py-2 font-medium">Send code</button>
                    <button type="button" id="verifyBtn" class="btn-primary flex-1 rounded-md px-4 py-2 font-medium hidden">Verify</button>
                </div>
                <p id="msg" class="text-sm"></p>
            </form>
        </div>
    </div>

        <!-- Success/Error Messages -->
        <div id="message" class="hidden">
            <div class="glass-effect rounded-xl p-4 shadow-lg">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg id="messageIcon" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p id="messageText" class="text-sm font-medium"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
                const loginForm = document.getElementById('loginForm');
                const emailInput = document.getElementById('email');
                const otpInput = document.getElementById('otp');
                const codeWrap = document.getElementById('codeWrap');
                const msg = document.getElementById('msg');
                const sendBtn = document.getElementById('sendBtn');
                const verifyBtn = document.getElementById('verifyBtn');

                function showMsg(text, ok = true) {
                    msg.textContent = text || '';
                    msg.className = ok ? 'text-sm text-green-600' : 'text-sm text-red-600';
                }

                async function parseResponse(res) {
                    const ct = res.headers.get('content-type') || '';
                    if (ct.includes('application/json')) {
                        return await res.json();
                    }
                    const text = await res.text();
                    return { success: false, message: text || `${res.status} ${res.statusText}` };
                }

                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = emailInput.value.trim();
                    if (!email) { showMsg('Please enter your email', false); return; }
                    sendBtn.disabled = true;
                    showMsg('Sending code...');
                    try {
                        const res = await fetch('/api/auth/send-otp', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email })
                        });
                        const data = await parseResponse(res);
                        if (!res.ok) {
                            console.error('send-otp failed:', res.status, res.statusText);
                        }
                        if (data.success) {
                            codeWrap.classList.remove('hidden');
                            verifyBtn.classList.remove('hidden');
                            sendBtn.classList.add('hidden');
                            showMsg('Code sent to your email.');
                        } else {
                            showMsg(data.message || 'Failed to send code', false);
                            sendBtn.disabled = false;
                        }
                    } catch (err) {
                        showMsg('Network error. Try again.', false);
                        sendBtn.disabled = false;
                    }
                });

                verifyBtn.addEventListener('click', async () => {
                    const email = emailInput.value.trim();
                    const otp = otpInput.value.trim();
                    if (!otp || otp.length !== 6) { showMsg('Enter the 6-digit code', false); return; }
                    verifyBtn.disabled = true;
                    showMsg('Verifying...');
                    try {
                        const res = await fetch('/api/auth/verify-otp', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, otp })
                        });
                        const data = await parseResponse(res);
                        if (!res.ok) {
                            console.error('verify-otp failed:', res.status, res.statusText);
                        }
                        if (data.success) {
                            localStorage.setItem('authToken', data.data.token);
                            localStorage.setItem('userData', JSON.stringify(data.data.user));
                            showMsg('Login successful');
                              window.location.href = data.data?.defaultActions?.redirectTo || '/order.html';
                        } else {
                            showMsg(data.message || 'Invalid code', false);
                            verifyBtn.disabled = false;
                        }
                    } catch (err) {
                        showMsg('Network error. Try again.', false);
                        verifyBtn.disabled = false;
                    }
                });

                // No auto-population of OTP
                // Keep the form simple: email -> send -> enter code -> verify
        
                async function sendOTPRequest(mobile) {
            try {
                const response = await fetch('/api/auth/send-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mobile })
                });

                const data = await response.json();

                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                btnText.textContent = 'Send Verification Code';

                if (data.success) {
                    // unused in simplified flow
                } else {
                    // unused in simplified flow
                }

            } catch (error) {
                console.error('Send OTP Error:', error);
                
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                btnText.textContent = 'Send Verification Code';
                
                showMessage('Network error. Please check your connection and try again.', 'error');
            }
    }

        // Show OTP input field
    // Removed complex OTP UI and auto-fill logic to keep the form simple

        // Setup OTP input handlers
    function setupOTPHandlers() {}

        // Verify OTP with backend
    async function verifyOTPRequest(mobile, otp) {
            try {
                const response = await fetch('/api/auth/verify-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mobile, otp })
                });

                const data = await response.json();

                const verifyBtn = document.getElementById('verifyBtn');
                const verifyBtnText = document.getElementById('verifyBtnText');
                
                verifyBtn.disabled = false;
                verifyBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                verifyBtnText.textContent = 'Verify & Login';

                if (data.success) {
                    // Store JWT token and comprehensive user data
                    localStorage.setItem('authToken', data.data.token);
                    localStorage.setItem('userData', JSON.stringify(data.data.user));
                    
                    showMessage('Login successful! Redirecting to dashboard...', 'success');
                    
                    // Clear session storage including development OTP
                    sessionStorage.removeItem('loginMobile');
                    sessionStorage.removeItem('developmentOTP');
                    
                    // Use default redirect from API response, fallback to user dashboard
                    // Simplified script removed
                } else {
                    showMessage(data.message || 'Invalid verification code', 'error');
                }

            } catch (error) {
                console.error('Verify OTP Error:', error);
                
                const verifyBtn = document.getElementById('verifyBtn');
                const verifyBtnText = document.getElementById('verifyBtnText');
                
                verifyBtn.disabled = false;
                verifyBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                verifyBtnText.textContent = 'Verify & Login';
                
                showMessage('Network error. Please check your connection and try again.', 'error');
            }
        }

    // Simplified; removed extra animations
    </script>
</body>
</html>
