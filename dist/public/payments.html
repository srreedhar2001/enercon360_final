<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payments - Enercon 360</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/navigation.js"></script>
    <script src="/js/access.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation Container -->
    <div id="navigation-container"></div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 mt-16">
        <div class="px-4 py-6 sm:px-0">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Payments</h1>
                    <p class="text-gray-600 mt-2">Manage payment transactions and records</p>
                </div>
                <div class="flex space-x-2">
                    <button id="refreshBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                    <button id="addPaymentBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add Payment
                    </button>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-8 w-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total Received</dt>
                                    <dd class="text-lg font-medium text-gray-900" id="totalReceived">₹0.00</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-8 w-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Pending Amount</dt>
                                    <dd class="text-lg font-medium text-gray-900" id="pendingAmount">₹0.00</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-8 w-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Today's Collections</dt>
                                    <dd class="text-lg font-medium text-gray-900" id="todayCollections">₹0.00</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-8 w-8 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total Transactions</dt>
                                    <dd class="text-lg font-medium text-gray-900" id="totalTransactions">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="searchInput" placeholder="Search by order ID, counter name, amount..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex gap-2">
                        <input type="date" id="dateFromFilter" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <input type="date" id="dateToFilter" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <select id="paymentMethodFilter" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">All Methods</option>
                            <option value="cash">Cash</option>
                            <option value="upi">UPI</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="cheque">Cheque</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Payments Table -->
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Payment Records</h3>
                        <div class="text-sm text-gray-500">
                            Showing <span id="recordCount">0</span> records
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-12">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-gray-500 mt-2">Loading payments...</p>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-12 hidden">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                        <p class="text-gray-500 text-lg">No payments found</p>
                        <p class="text-gray-400 text-sm mt-2">Start by adding your first payment record</p>
                    </div>

                    <!-- Payments Table -->
                    <div id="paymentsTable" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order Details</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Table rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Add Payment Record</h3>
                </div>
                <form id="paymentForm" class="p-6">
                    <div class="space-y-4">
                        <div>
                            <label for="paymentType" class="block text-sm font-medium text-gray-700">Payment Type *</label>
                            <select id="paymentType" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select payment type...</option>
                            </select>
                        </div>

                        <div id="userSelectContainer" class="hidden">
                            <label for="userSelect" class="block text-sm font-medium text-gray-700">Select User *</label>
                            <select id="userSelect" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Choose a user...</option>
                            </select>
                        </div>

                        <div id="counterSelectContainer" class="hidden">
                            <label for="counterSelect" class="block text-sm font-medium text-gray-700">Select Counter *</label>
                            <select id="counterSelect" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Choose a counter...</option>
                            </select>
                        </div>

                        <div>
                            <label for="paymentAmount" class="block text-sm font-medium text-gray-700">Payment Amount *</label>
                            <input type="number" id="paymentAmount" step="0.01" min="0.01" required 
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Enter payment amount">
                        </div>

                        <div>
                            <label for="paymentDate" class="block text-sm font-medium text-gray-700">Payment Date *</label>
                            <input type="date" id="paymentDate" required 
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div>
                            <label for="paymentMethod" class="block text-sm font-medium text-gray-700">Payment Method</label>
                            <select id="paymentMethod" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select method...</option>
                                <option value="cash">Cash</option>
                                <option value="upi">UPI</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="cheque">Cheque</option>
                                <option value="card">Card</option>
                            </select>
                        </div>

                        <div>
                            <label for="paymentNotes" class="block text-sm font-medium text-gray-700">Notes</label>
                            <textarea id="paymentNotes" rows="3" 
                                      class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="Additional notes (optional)"></textarea>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" id="cancelPaymentBtn" 
                                class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700">
                            Save Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Authentication helper functions
        function getAuthToken() {
            // Do not auto-create any tokens; enforce real authentication
            return localStorage.getItem('token') || localStorage.getItem('authToken') || null;
        }

        function getAuthHeaders() {
            const token = getAuthToken();
            return {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            };
        }

        // Payment Management System
        class PaymentManager {
            constructor() {
                this.payments = [];
                this.paymentTypes = [];
                this.users = [];
                this.counters = [];
                this.filteredPayments = [];
                this.init();
            }

            init() {
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }
                this.setTodayDate();
                this.setupEventListeners();
                this.loadData();
            }

            setTodayDate() {
                document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            }

            setupEventListeners() {
                // Refresh button
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadData();
                });

                // Add payment button
                document.getElementById('addPaymentBtn').addEventListener('click', () => {
                    this.openPaymentModal();
                });

                // Modal close buttons
                document.getElementById('cancelPaymentBtn').addEventListener('click', () => {
                    this.closePaymentModal();
                });

                // Form submission
                document.getElementById('paymentForm').addEventListener('submit', (e) => {
                    this.handlePaymentSubmit(e);
                });

                // Payment type change event
                document.getElementById('paymentType').addEventListener('change', (e) => {
                    this.handlePaymentTypeChange(e.target.value);
                });

                // Search and filter inputs
                document.getElementById('searchInput').addEventListener('input', () => {
                    this.filterPayments();
                });

                // Filter event listeners
                ['dateFromFilter', 'dateToFilter', 'paymentMethodFilter'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => {
                        this.filterPayments();
                    });
                });
            }

            async loadData() {
                this.showLoading();
                try {
                    await Promise.all([
                        this.loadStatistics(),
                        this.loadPayments(),
                        this.loadPaymentTypes(),
                        this.loadUsers(),
                        this.loadCounters()
                    ]);
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showError('Failed to load payment data');
                }
            }

            async loadStatistics() {
                try {
                    const response = await fetch('/api/payments/statistics', {
                        headers: getAuthHeaders()
                    });

                    if (response.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    if (response.ok) {
                        const result = await response.json();
                        const stats = result.data;
                        
                        document.getElementById('totalReceived').textContent = this.formatCurrency(stats.totalPayments + stats.totalCollections);
                        document.getElementById('pendingAmount').textContent = this.formatCurrency(stats.pendingAmount);
                        document.getElementById('todayCollections').textContent = this.formatCurrency(stats.todayPayments + stats.todayCollections);
                        document.getElementById('totalTransactions').textContent = stats.totalTransactions;
                    }
                } catch (error) {
                    console.error('Error loading statistics:', error);
                }
            }

            async loadPayments() {
                try {
                    const response = await fetch('/api/payments', {
                        headers: getAuthHeaders()
                    });

                    if (response.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    if (response.ok) {
                        const result = await response.json();
                        this.payments = result.data;
                        this.filteredPayments = [...this.payments];
                        this.renderPayments();
                    } else {
                        throw new Error('Failed to load payments');
                    }
                } catch (error) {
                    console.error('Error loading payments:', error);
                    this.showError('Failed to load payments');
                }
            }

            async loadPaymentTypes() {
                try {
                    const response = await fetch('/api/payments/types', {
                        headers: getAuthHeaders()
                    });

                    if (response.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    if (response.ok) {
                        const result = await response.json();
                        this.paymentTypes = result.data;
                        this.populatePaymentTypeSelect();
                    }
                } catch (error) {
                    console.error('Error loading payment types:', error);
                }
            }

            async loadUsers() {
                try {
                    const response = await fetch('/api/payments/users', {
                        headers: getAuthHeaders()
                    });

                    if (response.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    if (response.ok) {
                        const result = await response.json();
                        this.users = result.data;
                        this.populateUserSelect();
                    }
                } catch (error) {
                    console.error('Error loading users:', error);
                }
            }

            async loadCounters() {
                try {
                    const response = await fetch('/api/payments/counters', {
                        headers: getAuthHeaders()
                    });

                    if (response.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    if (response.ok) {
                        const result = await response.json();
                        this.counters = result.data;
                        this.populateCounterSelect();
                    }
                } catch (error) {
                    console.error('Error loading counters:', error);
                }
            }

            populatePaymentTypeSelect() {
                const select = document.getElementById('paymentType');
                select.innerHTML = '<option value="">Select payment type...</option>';
                
                this.paymentTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = type.serviceTypeName;
                    option.title = type.description;
                    option.setAttribute('data-name', type.serviceTypeName.toLowerCase());
                    select.appendChild(option);
                });
            }

            handlePaymentTypeChange(selectedTypeId) {
                const userContainer = document.getElementById('userSelectContainer');
                const counterContainer = document.getElementById('counterSelectContainer');
                const userSelect = document.getElementById('userSelect');
                const counterSelect = document.getElementById('counterSelect');
                
                if (!userContainer || !counterContainer || !userSelect || !counterSelect) {
                    console.error('Modal elements not found');
                    return;
                }
                
                // Reset selections
                userSelect.value = '';
                counterSelect.value = '';
                
                // Hide all containers first
                userContainer.classList.add('hidden');
                counterContainer.classList.add('hidden');
                
                // Remove required attributes
                userSelect.removeAttribute('required');
                counterSelect.removeAttribute('required');
                
                if (selectedTypeId) {
                    const selectedType = this.paymentTypes.find(type => type.id == selectedTypeId);
                    
                    if (selectedType) {
                        const typeName = selectedType.serviceTypeName.toLowerCase();
                        
                        // Show user dropdown for Salary and Expenses
                        if (typeName === 'salary' || typeName === 'expenses') {
                            userContainer.classList.remove('hidden');
                            userSelect.setAttribute('required', 'required');
                        }
                        // Show counter dropdown for Counter Service
                        else if (typeName === 'counter service') {
                            counterContainer.classList.remove('hidden');
                            counterSelect.setAttribute('required', 'required');
                        }
                        // For other types (Others, Product Purchase), no additional selection needed
                    }
                }
            }

            populateUserSelect() {
                const select = document.getElementById('userSelect');
                select.innerHTML = '<option value="">Choose a user...</option>';
                
                this.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (${user.mobile})`;
                    select.appendChild(option);
                });
            }

            populateCounterSelect() {
                const select = document.getElementById('counterSelect');
                select.innerHTML = '<option value="">Choose a counter...</option>';
                
                this.counters.forEach(counter => {
                    const option = document.createElement('option');
                    option.value = counter.id;
                    option.textContent = `${counter.name} (${counter.phone})`;
                    select.appendChild(option);
                });
            }

            renderPayments() {
                const tbody = document.getElementById('paymentsTableBody');
                
                if (this.filteredPayments.length === 0) {
                    this.showEmpty();
                    return;
                }

                this.showTable();
                tbody.innerHTML = '';

                this.filteredPayments.forEach(payment => {
                    const row = this.createPaymentRow(payment);
                    tbody.appendChild(row);
                });

                document.getElementById('recordCount').textContent = this.filteredPayments.length;
            }

            createPaymentRow(payment) {
                const tr = document.createElement('tr');
                
                // Determine the recipient/target based on payment type
                let recipient = 'General';
                if (payment.userName) {
                    recipient = `${payment.userName} (${payment.userMobile})`;
                } else if (payment.counterName) {
                    recipient = payment.counterName;
                }
                
                // Determine payment category badge color
                let badgeColor = 'bg-blue-100 text-blue-800';
                const typeName = payment.paymentType ? payment.paymentType.toLowerCase() : '';
                if (typeName === 'salary') {
                    badgeColor = 'bg-green-100 text-green-800';
                } else if (typeName === 'expenses') {
                    badgeColor = 'bg-red-100 text-red-800';
                } else if (typeName === 'counter service') {
                    badgeColor = 'bg-purple-100 text-purple-800';
                } else if (typeName === 'product purchase') {
                    badgeColor = 'bg-yellow-100 text-yellow-800';
                }
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${payment.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="font-medium">${payment.paymentType || 'N/A'}</div>
                        <div class="text-gray-500">${recipient}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600">${this.formatCurrency(payment.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(payment.paymentDate).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeColor}">
                            ${payment.paymentType || 'General'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            Completed
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="paymentManager.viewPayment(${payment.id})" class="text-indigo-600 hover:text-indigo-900 mr-2">View</button>
                        <button onclick="paymentManager.deletePayment(${payment.id})" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                return tr;
            }

            filterPayments() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const dateFrom = document.getElementById('dateFromFilter').value;
                const dateTo = document.getElementById('dateToFilter').value;
                const paymentMethod = document.getElementById('paymentMethodFilter').value;

                this.filteredPayments = this.payments.filter(payment => {
                    const matchesSearch = !searchTerm || 
                        payment.id.toString().includes(searchTerm) ||
                        (payment.paymentType && payment.paymentType.toLowerCase().includes(searchTerm)) ||
                        (payment.userName && payment.userName.toLowerCase().includes(searchTerm)) ||
                        (payment.counterName && payment.counterName.toLowerCase().includes(searchTerm)) ||
                        payment.amount.toString().includes(searchTerm);
                    // Normalize to Date objects for robust comparison
                    const payDate = new Date(payment.paymentDate);
                    const matchesDateFrom = !dateFrom || payDate >= new Date(dateFrom);
                    const matchesDateTo = !dateTo || payDate <= new Date(dateTo);
                    const matchesMethod = !paymentMethod; // General payments don't have specific methods

                    return matchesSearch && matchesDateFrom && matchesDateTo && matchesMethod;
                });

                this.renderPayments();
            }

            openPaymentModal() {
                document.getElementById('paymentModal').classList.remove('hidden');
                this.setTodayDate();
                // Ensure a clean state each time
                const paymentType = document.getElementById('paymentType');
                paymentType.value = '';
                const userContainer = document.getElementById('userSelectContainer');
                const counterContainer = document.getElementById('counterSelectContainer');
                const userSelect = document.getElementById('userSelect');
                const counterSelect = document.getElementById('counterSelect');
                userContainer.classList.add('hidden');
                counterContainer.classList.add('hidden');
                userSelect.removeAttribute('required');
                counterSelect.removeAttribute('required');
                userSelect.value = '';
                counterSelect.value = '';
            }

            closePaymentModal() {
                document.getElementById('paymentModal').classList.add('hidden');
                document.getElementById('paymentForm').reset();
                
                // Reset conditional dropdowns
                document.getElementById('userSelectContainer').classList.add('hidden');
                document.getElementById('counterSelectContainer').classList.add('hidden');
                document.getElementById('userSelect').removeAttribute('required');
                document.getElementById('counterSelect').removeAttribute('required');
                
                this.setTodayDate();
            }

            async handlePaymentSubmit(e) {
                e.preventDefault();
                const saveBtn = e.submitter || document.querySelector('#paymentForm button[type="submit"]');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Saving...';
                }
                
                const serviceTypeId = document.getElementById('paymentType').value;
                const userId = document.getElementById('userSelect').value || null;
                const counterId = document.getElementById('counterSelect').value || null;
                const amount = parseFloat(document.getElementById('paymentAmount').value);
                const paymentDate = document.getElementById('paymentDate').value;
                const comments = document.getElementById('paymentNotes').value || null;

                // Validate required fields
                if (!serviceTypeId || !amount || !paymentDate) {
                    alert('Please fill in all required fields');
                    return;
                }

                // Validate conditional required fields based on payment type
                const selectedType = this.paymentTypes.find(type => type.id == serviceTypeId);
                if (selectedType) {
                    const typeName = selectedType.serviceTypeName.toLowerCase();
                    
                    if ((typeName === 'salary' || typeName === 'expenses') && !userId) {
                        alert('Please select a user for salary/expense payments');
                        return;
                    }
                    
                    if (typeName === 'counter service' && !counterId) {
                        alert('Please select a counter for counter service payments');
                        return;
                    }
                }

                const formData = {
                    serviceTypeId,
                    userId,
                    counterId,
                    amount,
                    paymentDate,
                    comments
                };

                try {
                    const response = await fetch('/api/payments', {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (response.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    if (response.ok) {
                        this.closePaymentModal();
                        this.loadData(); // Refresh data
                        alert('Payment record saved successfully!');
                    } else {
                        alert(result.message || 'Failed to save payment record');
                    }
                } catch (error) {
                    console.error('Error saving payment:', error);
                    alert('Failed to save payment record');
                } finally {
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Save Payment';
                    }
                }
            }

            async viewPayment(id) {
                try {
                    const response = await fetch(`/api/payments/${id}`, {
                        headers: getAuthHeaders()
                    });

                    if (response.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    if (response.ok) {
                        const result = await response.json();
                        const payment = result.data;
                        
                        let details = `Payment Details:\n\n`;
                        details += `ID: #${payment.id}\n`;
                        details += `Type: ${payment.paymentType}\n`;
                        details += `Amount: ${this.formatCurrency(payment.amount)}\n`;
                        details += `Date: ${new Date(payment.paymentDate).toLocaleDateString()}\n`;
                        if (payment.userName) details += `User: ${payment.userName} (${payment.userMobile})\n`;
                        if (payment.counterName) details += `Counter: ${payment.counterName}\n`;
                        if (payment.comments) details += `Comments: ${payment.comments}\n`;
                        details += `Created: ${new Date(payment.createdAt).toLocaleString()}`;
                        
                        alert(details);
                    } else {
                        alert('Failed to load payment details');
                    }
                } catch (error) {
                    console.error('Error viewing payment:', error);
                    alert('Failed to load payment details');
                }
            }

            async deletePayment(id) {
                if (!confirm('Are you sure you want to delete this payment record?')) {
                    return;
                }

                try {
                    const response = await fetch(`/api/payments/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });

                    const result = await response.json();

                    if (response.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    if (response.ok) {
                        this.loadData(); // Refresh data
                        alert('Payment record deleted successfully!');
                    } else {
                        alert(result.message || 'Failed to delete payment record');
                    }
                } catch (error) {
                    console.error('Error deleting payment:', error);
                    alert('Failed to delete payment record');
                }
            }

            showLoading() {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('paymentsTable').classList.add('hidden');
            }

            showEmpty() {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('paymentsTable').classList.add('hidden');
            }

            showTable() {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('paymentsTable').classList.remove('hidden');
            }

            showError(message) {
                console.error(message);
                alert(message);
            }

            formatCurrency(amount) {
                return `₹${parseFloat(amount || 0).toFixed(2)}`;
            }
        }

        // Global variable for access in onclick handlers
        let paymentManager;

        // Initialize the payment manager when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Redirect immediately if not authenticated
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            // Enforce page-level permission for payments module
            if (window.ensurePagePermission) {
                window.ensurePagePermission('payments', 'view');
            } else if (window.ensurePageAccess) {
                window.ensurePageAccess('payments');
            }
            // Load navigation via NavigationLoader
            if (window.NavigationLoader && typeof window.NavigationLoader.loadNavigation === 'function') {
                window.NavigationLoader.loadNavigation();
                if (window.applyNavPermissions) window.applyNavPermissions();
            }
            
            // Initialize payment manager
            paymentManager = new PaymentManager();
        });
    </script>
</body>
</html>
