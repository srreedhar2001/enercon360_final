<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counter Management - Enercon 360</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/navigation.js"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation Container -->
    <div id="navigation-container"></div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 mt-16">
        <!-- Header Section -->
        <div class="px-4 py-6 sm:px-0">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">Counter Management</h2>
                    <p class="text-gray-600">Manage your pharmaceutical distribution counters</p>
                </div>
                <button id="addCounterBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium">
                    Add New Counter
                </button>
            </div>

            <!-- Representative Stats Cards -->
            <div id="representativeStatsCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                <!-- Cards will be loaded dynamically -->
            </div>

            <!-- Search and Filter Section -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="searchCounters" 
                               placeholder="Search counters by name, city, or GST..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex gap-2">
                        <select id="cityFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">All Cities</option>
                            <!-- Cities will be loaded dynamically -->
                        </select>
                        <button id="clearFiltersBtn" onclick="clearFilters()" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg">
                            Clear Filters
                        </button>
                        <button id="refreshBtn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Counters Grid -->
            <div id="countersContainer" class="space-y-6">
                <!-- Counters will be loaded here -->
                <div class="text-center py-8">
                    <div class="text-gray-500">Loading counters...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Counter Modal -->
    <div id="counterModal" class="fixed inset-0 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="modalTitle" class="text-lg font-semibold text-gray-900">Add New Counter</h3>
                        <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <form id="counterForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Counter Name *</label>
                                <input type="text" id="counterName" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">City *</label>
                                <select id="counterCity" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select City</option>
                                    <!-- Cities will be loaded dynamically -->
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Sales Representative *</label>
                                <select id="counterRep" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select Representative</option>
                                    <!-- Representatives will be loaded dynamically -->
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Manager</label>
                                <select id="counterManager"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select Manager</option>
                                    <!-- Managers will be loaded dynamically -->
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Longitude *</label>
                                <input type="number" id="counterLongitude" step="0.0000001" required
                                       placeholder="e.g. 77.2345678 (0 if unknown)"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Latitude *</label>
                                <input type="number" id="counterLatitude" step="0.0000001" required
                                       placeholder="e.g. 28.1234567 (0 if unknown)"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                                <input type="tel" id="counterPhone" maxlength="15"
                                       placeholder="+91 9876543210"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">GST Number</label>
                                <input type="text" id="counterGst" maxlength="20"
                                       placeholder="22AAAAA0000A1Z5"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Created Date</label>
                                <input type="date" id="counterCreatedDate"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                <textarea id="counterAddress" rows="3"
                                          placeholder="Complete address of the counter..."
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                        </div>

                        <div class="flex space-x-3 pt-4">
                            <button type="submit" id="submitBtn"
                                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg font-medium">
                                Add Counter
                            </button>
                            <button type="button" id="cancelBtn"
                                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg font-medium">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let counters = [];
        let cities = [];
        let representatives = [];
        let managers = [];
        let editingCounterId = null;

        // DOM elements
        const countersContainer = document.getElementById('countersContainer');
        const counterModal = document.getElementById('counterModal');
        const counterForm = document.getElementById('counterForm');
        const addCounterBtn = document.getElementById('addCounterBtn');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const modalTitle = document.getElementById('modalTitle');
        const submitBtn = document.getElementById('submitBtn');
        const searchCounters = document.getElementById('searchCounters');
        const cityFilter = document.getElementById('cityFilter');
        const refreshBtn = document.getElementById('refreshBtn');

        // API Helper functions
        function getAuthToken() {
            return localStorage.getItem('authToken') || localStorage.getItem('token') || null;
        }

        function getAuthHeaders() {
            const token = getAuthToken();
            return {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            };
        }

        async function makeAPIRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        ...getAuthHeaders(),
                        ...options.headers
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('Authentication failed');
                        throw new Error('Unauthorized access - please log in');
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }

        // API functions to fetch real data from database
        async function fetchCounters() {
            try {
                const token = getAuthToken();
                if (!token) throw new Error('NoAuth');
                
                const response = await fetch('/api/counters', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) throw new Error('Unauthorized');
                    throw new Error('FetchCountersFailed');
                }

                const data = await response.json();
                return data.data || data.counters || data;
            } catch (error) {
                console.error('Error fetching counters:', error);
                if (String(error).includes('Unauthorized') || String(error).includes('NoAuth')) {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                    return [];
                }
                showError('Failed to load counters');
                return [];
            }
        }

        // Simulated data based on actual counters table structure
        async function getSimulatedCountersData() {
            // This simulates the actual data from your counters table
            const counters = [
                {
                    id: 1,
                    CounterName: "SRIDHAR MEDICAL",
                    CityID: 1,
                    cityName: "Visakhapatnam",
                    RepID: 3,
                    repName: "Sales Rep 1",
                    longitude: 83.2185,
                    latitude: 17.6868,
                    phone: "9876543210",
                    gst: "37ABCDE1234F1Z5",
                    address: "Medical Complex, Visakhapatnam"
                },
                {
                    id: 2,
                    CounterName: "APOLLO PHARMACY",
                    CityID: 4,
                    cityName: "Vijayawada",
                    RepID: 4,
                    repName: "Sales Rep 2",
                    longitude: 80.6480,
                    latitude: 16.5062,
                    phone: "9876543211",
                    gst: "37ABCDE2234F1Z5",
                    address: "MG Road, Vijayawada"
                },
                {
                    id: 11,
                    CounterName: "Counter 11",
                    CityID: 1,
                    cityName: "Visakhapatnam",
                    RepID: 3,
                    repName: "Sales Rep 1",
                    longitude: 83.2200,
                    latitude: 17.6900,
                    phone: "9876543212",
                    gst: "37ABCDE1134F1Z5",
                    address: "Beach Road, Visakhapatnam"
                },
                {
                    id: 12,
                    CounterName: "MEDPLUS PHARMACY",
                    CityID: 6,
                    cityName: "Guntur",
                    RepID: 8,
                    repName: "Sales Rep 3",
                    longitude: 80.4365,
                    latitude: 16.3067,
                    phone: "9876543213",
                    gst: "37ABCDE1244F1Z5",
                    address: "Collectorate Road, Guntur"
                },
                {
                    id: 13,
                    CounterName: "RELIANCE PHARMACY",
                    CityID: 7,
                    cityName: "Tirupati",
                    RepID: 9,
                    repName: "Sales Rep 4",
                    longitude: 79.4192,
                    latitude: 13.6288,
                    phone: "9876543214",
                    gst: "37ABCDE1344F1Z5",
                    address: "Temple Street, Tirupati"
                },
                {
                    id: 26,
                    CounterName: "API Test Counter1",
                    CityID: 8,
                    cityName: "Kurnool",
                    RepID: 10,
                    repName: "Sales Rep 5",
                    longitude: 78.0322,
                    latitude: 15.8281,
                    phone: "9876543215",
                    gst: "37ABCDE2644F1Z5",
                    address: "Hospital Road, Kurnool"
                }
            ];
            return counters;
        }

        async function fetchCities() {
            try {
                const token = getAuthToken();
                if (!token) throw new Error('NoAuth');
                
                const response = await fetch('/api/cities', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) throw new Error('Unauthorized');
                    throw new Error('FetchCitiesFailed');
                }

                const data = await response.json();
                return data.data || data.cities || data;
            } catch (error) {
                console.error('Error fetching cities:', error);
                if (String(error).includes('Unauthorized') || String(error).includes('NoAuth')) {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                    return [];
                }
                showError('Failed to load cities');
                return [];
            }
        }

        async function getSimulatedCityData() {
            // This matches your actual city table data
            const cities = [
                { id: 1, city: "Visakhapatnam", district: "Visakhapatnam", state: "Andhra Pradesh" },
                { id: 4, city: "Vijayawada", district: "Krishna", state: "Andhra Pradesh" },
                { id: 6, city: "Guntur", district: "Guntur", state: "Andhra Pradesh" },
                { id: 7, city: "Tirupati", district: "Chittoor", state: "Andhra Pradesh" },
                { id: 8, city: "Kurnool", district: "Kurnool", state: "Andhra Pradesh" },
                { id: 9, city: "Nellore", district: "Nellore", state: "Andhra Pradesh" },
                { id: 10, city: "Kadapa", district: "Kadapa", state: "Andhra Pradesh" }
            ];
            return cities;
        }

        async function fetchRepresentatives() {
            try {
                const token = getAuthToken();
                if (!token) throw new Error('NoAuth');
                
                const response = await fetch('/api/representatives', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) throw new Error('Unauthorized');
                    throw new Error('FetchRepsFailed');
                }

                const data = await response.json();
                return data.data || data.representatives || data;
            } catch (error) {
                console.error('Error fetching representatives:', error);
                if (String(error).includes('Unauthorized') || String(error).includes('NoAuth')) {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                    return [];
                }
                showError('Failed to load representatives');
                return [];
            }
        }

        async function getSimulatedRepData() {
            // Sales representatives data structure
            const representatives = [
                { id: 3, name: "Rajesh Kumar", territory: "Visakhapatnam", phone: "9876543301" },
                { id: 4, name: "Priya Sharma", territory: "Vijayawada", phone: "9876543302" },
                { id: 8, name: "Suresh Babu", territory: "Guntur", phone: "9876543303" },
                { id: 9, name: "Lakshmi Devi", territory: "Tirupati", phone: "9876543304" },
                { id: 10, name: "Ravi Teja", territory: "Kurnool", phone: "9876543305" },
                { id: 11, name: "Anitha Reddy", territory: "Nellore", phone: "9876543306" },
                { id: 12, name: "Venkat Rao", territory: "Kadapa", phone: "9876543307" }
            ];
            return representatives;
        }

        async function fetchManagers() {
            try {
                const token = getAuthToken();
                if (!token) throw new Error('NoAuth');
                
                const response = await fetch('/api/users?designation_id=1', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    console.log('Using simulated manager data');
                    return await getSimulatedManagerData();
                }

                const data = await response.json();
                const allUsers = data.data || data.users || data;
                
                // Filter for managers (designation_id = 1)
                const managers = allUsers.filter(user => user.designation_id === 1);
                return managers;
            } catch (error) {
                console.error('Error fetching managers, using simulated data:', error);
                // If not authenticated, redirect to login
                if (String(error).includes('NoAuth')) {
                    window.location.href = '/login.html';
                    return [];
                }
                return await getSimulatedManagerData();
            }
        }

        async function getSimulatedManagerData() {
            // Managers data structure
            const managers = [
                { id: 1, name: "Balu", phone: "8787878787", designation_id: 1 },
                { id: 2, name: "Regional Manager", phone: "9876543210", designation_id: 1 }
            ];
            return managers;
        }

        // Utility functions
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                document.body.removeChild(errorDiv);
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                document.body.removeChild(successDiv);
            }, 3000);
        }

        function toYMD(dateLike) {
            try {
                const d = new Date(dateLike);
                if (isNaN(d)) return '';
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            } catch {
                return '';
            }
        }

        function showAuthenticationError() {
            countersContainer.innerHTML = `
                <div class="text-center py-12">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 max-w-md mx-auto">
                        <div class="flex items-center justify-center w-12 h-12 bg-yellow-100 rounded-full mx-auto mb-4">
                            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Authentication Required</h3>
                        <p class="text-gray-600 mb-4">Please log in to access the counter management system.</p>
                        <div class="flex gap-3 justify-center">
                            <button onclick="window.location.href='/login.html'" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium">
                                Go to Login
                            </button>
                            <button onclick="useDemoMode()" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium">
                                Demo Mode
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function useDemoMode() {
            // Demo mode disabled; require real authentication
            window.location.href = '/login.html';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Load navigation first
            try {
                NavigationLoader.loadNavigation();
                console.log('Navigation loader called successfully');
            } catch (error) {
                console.error('Navigation loader error:', error);
            }

            // Check authentication
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            // Try to load data
            try {
                await loadInitialData();
                setupEventListeners();
            } catch (error) {
                console.error('Failed to initialize:', error);
                if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    showAuthenticationError();
                } else {
                    showError('Failed to load application data');
                }
            }
        });

        async function loadInitialData() {
            try {
                // Load data in parallel
                const [countersData, citiesData, repsData, managersData] = await Promise.all([
                    fetchCounters(),
                    fetchCities(),
                    fetchRepresentatives(),
                    fetchManagers()
                ]);
                
                counters = countersData;
                cities = citiesData;
                representatives = repsData;
                managers = managersData;
                
                populateDropdowns();
                renderRepresentativeStats(counters);
                renderCounters(counters);
            } catch (error) {
                console.error('Error loading initial data:', error);
                showError('Failed to load initial data');
            }
        }

        function populateDropdowns() {
            // Populate city filter
            const cityOptions = cities.map(city => 
                `<option value="${city.id}">${city.city}</option>`
            ).join('');
            
            cityFilter.innerHTML = `
                <option value="">All Cities</option>
                ${cityOptions}
            `;

            // Populate modal dropdowns
            const modalCitySelect = document.getElementById('counterCity');
            modalCitySelect.innerHTML = `
                <option value="">Select City</option>
                ${cityOptions}
            `;

            const repOptions = representatives.map(rep => 
                `<option value="${rep.id}">${rep.name}</option>`
            ).join('');
            
            const modalRepSelect = document.getElementById('counterRep');
            modalRepSelect.innerHTML = `
                <option value="">Select Representative</option>
                ${repOptions}
            `;

            const managerOptions = managers.map(manager => 
                `<option value="${manager.id}">${manager.name}</option>`
            ).join('');
            
            const modalManagerSelect = document.getElementById('counterManager');
            modalManagerSelect.innerHTML = `
                <option value="">Select Manager</option>
                ${managerOptions}
            `;
        }

        function setupEventListeners() {
            addCounterBtn.addEventListener('click', openAddModal);
            closeModal.addEventListener('click', closeCounterModal);
            cancelBtn.addEventListener('click', closeCounterModal);
            counterForm.addEventListener('submit', handleSubmit);
            searchCounters.addEventListener('input', filterCounters);
            cityFilter.addEventListener('change', filterCounters);
            refreshBtn.addEventListener('click', refreshData);

            // Close modal when clicking outside
            counterModal.addEventListener('click', (e) => {
                if (e.target === counterModal) {
                    closeCounterModal();
                }
            });
        }

        function renderRepresentativeStats(counterList) {
            const statsContainer = document.getElementById('representativeStatsCards');
            
            // Calculate counters by representative
            const repStats = {};
            let totalCounters = 0;
            
            counterList.forEach(counter => {
                totalCounters++;
                const repName = counter.repName || counter.representativeName || 'Unknown Representative';
                const repId = counter.RepID || counter.repId;
                
                if (!repStats[repId]) {
                    repStats[repId] = {
                        name: repName,
                        count: 0,
                        counters: []
                    };
                }
                repStats[repId].count++;
                repStats[repId].counters.push(counter);
            });

            // Convert to array and sort by count (descending)
            const sortedStats = Object.values(repStats).sort((a, b) => b.count - a.count);
            
            // Add total card
            const totalCard = `
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow p-6 text-white">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="flex items-center justify-center w-8 h-8 bg-blue-200 rounded-full">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-blue-100 truncate">Total Counters</dt>
                                <dd class="text-2xl font-bold text-white">${totalCounters}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            `;

            // Generate representative cards
            const repCards = sortedStats.map((rep, index) => {
                const colors = [
                    'from-green-500 to-green-600',
                    'from-purple-500 to-purple-600', 
                    'from-yellow-500 to-yellow-600',
                    'from-red-500 to-red-600',
                    'from-indigo-500 to-indigo-600',
                    'from-pink-500 to-pink-600'
                ];
                const colorClass = colors[index % colors.length] || 'from-gray-500 to-gray-600';
                
                return `
                    <div class="bg-gradient-to-r ${colorClass} rounded-lg shadow p-6 text-white cursor-pointer hover:shadow-lg transition-all duration-200"
                         onclick="filterByRepresentative('${rep.name}')">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="flex items-center justify-center w-8 h-8 bg-white bg-opacity-20 rounded-full">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-white text-opacity-80 truncate">${rep.name}</dt>
                                    <dd class="text-2xl font-bold text-white">${rep.count} counter${rep.count !== 1 ? 's' : ''}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            statsContainer.innerHTML = totalCard + repCards;
        }

        function filterByRepresentative(repName) {
            // Filter counters by the selected representative
            const filtered = counters.filter(counter => {
                const counterRepName = counter.repName || counter.representativeName || 'Unknown Representative';
                return counterRepName === repName;
            });
            
            // Update the search field to show what's being filtered
            const searchInput = document.getElementById('searchCounters');
            searchInput.value = `Representative: ${repName}`;
            
            // Render filtered results
            renderCounters(filtered);
            
            // Show a notice
            showSuccess(`Showing ${filtered.length} counter${filtered.length !== 1 ? 's' : ''} for ${repName}`);
        }

        function clearFilters() {
            // Clear search input
            document.getElementById('searchCounters').value = '';
            // Clear city filter
            document.getElementById('cityFilter').value = '';
            // Show all counters
            renderRepresentativeStats(counters);
            renderCounters(counters);
            showSuccess('Filters cleared - showing all counters');
        }

        function renderCounters(counterList) {
            if (counterList.length === 0) {
                countersContainer.innerHTML = `
                    <div class="text-center py-12">
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 max-w-md mx-auto">
                            <div class="flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mx-auto mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H9m0 0H5m0 0h2M7 7h10M7 11h6"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No Counters Found</h3>
                            <p class="text-gray-600 mb-4">No pharmaceutical counters match your current filters.</p>
                            <button onclick="document.getElementById('addCounterBtn').click()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium">
                                Add First Counter
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            countersContainer.innerHTML = `
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
                        <p class="text-sm text-gray-600">
                            <strong>${counterList.length}</strong> counter${counterList.length !== 1 ? 's' : ''} found
                            ${counterList.length !== counters.length ? ` (${counters.length} total)` : ''}
                        </p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Counter Details</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sales Rep</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GPS Coordinates</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact Info</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${counterList.map(counter => `
                                    <tr class="hover:bg-gray-50 fade-in">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">${escapeHtml(counter.CounterName)}</div>
                                                <div class="text-sm text-gray-500">ID: ${counter.id}</div>
                                                ${counter.gst ? `<div class="text-xs text-gray-500">GST: ${escapeHtml(counter.gst)}</div>` : ''}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-gray-900">${escapeHtml(counter.cityName || 'N/A')}</div>
                                            ${counter.address ? `<div class="text-xs text-gray-500 max-w-xs truncate" title="${escapeHtml(counter.address)}">${escapeHtml(counter.address)}</div>` : ''}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900">${escapeHtml(counter.repName || 'N/A')}</div>
                                            <div class="text-xs text-gray-500">Rep ID: ${counter.RepID}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-xs text-gray-900">
                                                <div>Lat: ${counter.latitude}°</div>
                                                <div>Lng: ${counter.longitude}°</div>
                                            </div>
                                            <button onclick="openMapLocation(${counter.latitude}, ${counter.longitude})" 
                                                    class="text-xs text-blue-600 hover:text-blue-800 mt-1">
                                                📍 View on Map
                                            </button>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900">
                                                ${counter.phone ? `<div>📞 ${escapeHtml(counter.phone)}</div>` : '<div class="text-gray-400">No phone</div>'}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <div class="flex space-x-2">
                                                <button onclick="editCounter(${counter.id})" 
                                                        class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 hover:bg-indigo-100 px-2 py-1 rounded text-xs">
                                                    ✏️ Edit
                                                </button>
                                                <button onclick="deleteCounter(${counter.id})" 
                                                        class="text-red-600 hover:text-red-900 bg-red-50 hover:bg-red-100 px-2 py-1 rounded text-xs">
                                                    🗑️ Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Helper function to open map location
        function openMapLocation(lat, lng) {
            const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
            window.open(googleMapsUrl, '_blank');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function filterCounters() {
            const search = searchCounters.value.toLowerCase();
            const city = cityFilter.value;

            let filtered = [...counters];

            if (search) {
                filtered = filtered.filter(counter => 
                    counter.CounterName.toLowerCase().includes(search) ||
                    (counter.cityName && counter.cityName.toLowerCase().includes(search)) ||
                    (counter.gst && counter.gst.toLowerCase().includes(search)) ||
                    (counter.phone && counter.phone.includes(search))
                );
            }

            if (city) {
                filtered = filtered.filter(counter => counter.CityID == city);
            }

            renderRepresentativeStats(filtered);
            renderCounters(filtered);
        }

        function openAddModal() {
            editingCounterId = null;
            modalTitle.textContent = 'Add New Counter';
            submitBtn.textContent = 'Add Counter';
            counterForm.reset();
            // Default created date to today
            const cd = document.getElementById('counterCreatedDate');
            if (cd) {
                const today = new Date();
                cd.value = toYMD(today);
            }
            counterModal.classList.remove('hidden');
        }

        function editCounter(id) {
            const counter = counters.find(c => c.id === id);
            if (!counter) return;

            editingCounterId = id;
            modalTitle.textContent = 'Edit Counter';
            submitBtn.textContent = 'Update Counter';

            // Populate form
            document.getElementById('counterName').value = counter.CounterName;
            document.getElementById('counterCity').value = counter.CityID;
            document.getElementById('counterRep').value = counter.RepID;
            document.getElementById('counterLongitude').value = counter.longitude;
            document.getElementById('counterLatitude').value = counter.latitude;
            document.getElementById('counterPhone').value = counter.phone || '';
            document.getElementById('counterGst').value = counter.gst || '';
            document.getElementById('counterAddress').value = counter.address || '';

            // Populate created date if available
            const cd = document.getElementById('counterCreatedDate');
            if (cd) {
                const raw = counter.createdDate || counter.CreatedDate || counter.created_at || counter.createdAt;
                cd.value = raw ? toYMD(raw) : '';
            }

            counterModal.classList.remove('hidden');
        }

        async function deleteCounter(id) {
            if (confirm('Are you sure you want to delete this counter? This action cannot be undone.')) {
                try {
                    const token = getAuthToken();
                    if (!token) throw new Error('NoAuth');
                    
                    const response = await fetch(`/api/counters/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401) throw new Error('Unauthorized');
                        throw new Error('DeleteFailed');
                    } else {
                        // Refresh data from server
                        await loadInitialData();
                        showSuccess('Counter deleted successfully');
                    }
                    
                    filterCounters();
                } catch (error) {
                    console.error('Error deleting counter:', error);
                    if (String(error).includes('Unauthorized') || String(error).includes('NoAuth')) {
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('token');
                        window.location.href = '/login.html';
                        return;
                    }
                    showError('Failed to delete counter');
                }
            }
        }

        function closeCounterModal() {
            counterModal.classList.add('hidden');
            counterForm.reset();
            editingCounterId = null;
        }

        async function refreshData() {
            try {
                showSuccess('Refreshing data from database...');
                await loadInitialData();
                showSuccess('Data refreshed successfully');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showError('Failed to refresh data from database');
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();

            // Get form data
            const counterData = {
                CounterName: document.getElementById('counterName').value.trim(),
                CityID: parseInt(document.getElementById('counterCity').value),
                RepID: parseInt(document.getElementById('counterRep').value),
                longitude: parseFloat(document.getElementById('counterLongitude').value),
                latitude: parseFloat(document.getElementById('counterLatitude').value),
                phone: document.getElementById('counterPhone').value.trim(),
                gst: document.getElementById('counterGst').value.trim(),
                address: document.getElementById('counterAddress').value.trim()
            };

            // Include createdDate if provided
            const createdDateVal = document.getElementById('counterCreatedDate')?.value;
            if (createdDateVal) {
                counterData.createdDate = createdDateVal;
            }

            // Basic validation
            if (!counterData.CounterName || !counterData.CityID || !counterData.RepID) {
                showError('Please fill in all required fields');
                return;
            }

            if (isNaN(counterData.longitude) || isNaN(counterData.latitude)) {
                showError('Please enter valid GPS coordinates');
                return;
            }

            try {
                const token = getAuthToken();
                if (!token) throw new Error('NoAuth');
                
                if (editingCounterId) {
                    // Update existing counter
                    const response = await fetch(`/api/counters/${editingCounterId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(counterData)
                    });

                    if (!response.ok) {
                        if (response.status === 401) throw new Error('Unauthorized');
                        throw new Error('UpdateFailed');
                    } else {
                        // Refresh data from server
                        await loadInitialData();
                    }
                    showSuccess('Counter updated successfully');
                } else {
                    // Add new counter
                    const response = await fetch('/api/counters', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(counterData)
                    });

                    if (!response.ok) {
                        if (response.status === 401) throw new Error('Unauthorized');
                        throw new Error('CreateFailed');
                    } else {
                        // Refresh data from server
                        await loadInitialData();
                    }
                    showSuccess('Counter created successfully');
                }

                closeCounterModal();
                filterCounters();
            } catch (error) {
                console.error('Error saving counter:', error);
                if (String(error).includes('Unauthorized') || String(error).includes('NoAuth')) {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                    return;
                }
                showError('Failed to save counter');
            }
        }
    </script>
</body>
</html>
