<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Management</title>
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Manage doctor contact details and assignments for representatives.">
    <link rel="icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/navigation.js" defer></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="navigation-container"></div>

    <main class="container mx-auto px-4 py-8 pt-24">
        <div class="max-w-6xl mx-auto space-y-6">
            <section class="bg-white shadow-sm rounded-xl border border-gray-100 p-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Doctor Management</h1>
                        <p class="text-sm text-gray-500 mt-1">Create and manage doctor listings by representative.</p>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-gray-500 bg-gray-100 px-3 py-1.5 rounded-lg">
                        <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                        <span id="statusMessage">Ready</span>
                    </div>
                </div>

                <form id="doctorForm" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="doctorId" />

                    <div>
                        <label for="formRepresentative" class="block text-sm font-medium text-gray-700 mb-1">Representative<span class="text-red-500">*</span></label>
                        <select id="formRepresentative" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                            <option value="">Select representative</option>
                        </select>
                    </div>

                    <div>
                        <label for="formDoctorName" class="block text-sm font-medium text-gray-700 mb-1">Doctor Name<span class="text-red-500">*</span></label>
                        <input id="formDoctorName" type="text" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Dr. John Doe" required maxlength="150" />
                    </div>

                    <div>
                        <label for="formCity" class="block text-sm font-medium text-gray-700 mb-1">City<span class="text-red-500">*</span></label>
                        <select id="formCity" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                            <option value="">Select city</option>
                        </select>
                    </div>

                    <div>
                        <label for="formSpeciality" class="block text-sm font-medium text-gray-700 mb-1">Speciality<span class="text-red-500">*</span></label>
                        <select id="formSpeciality" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                            <option value="">Select speciality</option>
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label for="formAddress" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                        <textarea id="formAddress" rows="2" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Clinic address or notes"></textarea>
                    </div>

                    <div class="flex items-center gap-2">
                        <input id="formActive" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded" checked />
                        <label for="formActive" class="text-sm text-gray-700">Active</label>
                    </div>

                    <div class="md:col-span-2 flex flex-wrap items-center gap-3 pt-2">
                        <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-semibold shadow hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                            <span id="formSubmitLabel">Save doctor</span>
                        </button>
                        <button type="button" id="formResetBtn" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 text-sm font-semibold text-gray-700 hover:bg-gray-100 focus:ring-2 focus:ring-gray-300 focus:outline-none">
                            Clear
                        </button>
                        <span id="formFeedback" class="text-sm text-gray-500 hidden"></span>
                    </div>
                </form>
            </section>

            <section class="bg-white shadow-sm rounded-xl border border-gray-100">
                <div class="px-6 pt-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">Doctors list</h2>
                        <p class="text-sm text-gray-500">Select a representative to view their doctors.</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-3">
                        <div>
                            <label for="filterRepresentative" class="block text-xs font-medium text-gray-500">Representative</label>
                            <select id="filterRepresentative" class="min-w-[220px] rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Select representative</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterStatus" class="block text-xs font-medium text-gray-500">Status</label>
                            <select id="filterStatus" class="rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="all">All</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="doctorsAlert" class="hidden mx-6 mt-4 rounded-lg border px-4 py-3 text-sm"></div>

                <div class="overflow-x-auto mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">#</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Doctor</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Representative</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">City</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Speciality</th>
                                <th class="px-6 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="doctorsTableBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                </div>

                <div class="px-6 pb-6 pt-4 flex items-center justify-between text-xs text-gray-500">
                    <span id="doctorsCountLabel">0 doctors</span>
                    <span>Updated <time id="doctorsUpdatedAt">—</time></span>
                </div>
            </section>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('authToken') || localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            await NavigationLoader.loadNavigation();
            if (typeof window.ensurePagePermission === 'function') {
                try { await window.ensurePagePermission('doctor-calls'); } catch (_) {}
            }

            const statusMessage = document.getElementById('statusMessage');
            const doctorForm = document.getElementById('doctorForm');
            const doctorIdInput = document.getElementById('doctorId');
            const formRepresentative = document.getElementById('formRepresentative');
            const formDoctorName = document.getElementById('formDoctorName');
            const formCity = document.getElementById('formCity');
            const formSpeciality = document.getElementById('formSpeciality');
            const formAddress = document.getElementById('formAddress');
            const formActive = document.getElementById('formActive');
            const formSubmitLabel = document.getElementById('formSubmitLabel');
            const formResetBtn = document.getElementById('formResetBtn');
            const formFeedback = document.getElementById('formFeedback');
            const filterRepresentative = document.getElementById('filterRepresentative');
            const filterStatus = document.getElementById('filterStatus');
            const doctorsTableBody = document.getElementById('doctorsTableBody');
            const doctorsCountLabel = document.getElementById('doctorsCountLabel');
            const doctorsUpdatedAt = document.getElementById('doctorsUpdatedAt');
            const doctorsAlert = document.getElementById('doctorsAlert');

            const state = {
                representatives: [],
                cities: [],
                specialities: [],
                doctors: []
            };

            const STORAGE_KEYS = Object.freeze({
                representative: 'doctorManagement.filterRepresentative',
                status: 'doctorManagement.filterStatus'
            });

            const storage = {
                get(key) {
                    try {
                        return localStorage.getItem(key);
                    } catch (_) {
                        return null;
                    }
                },
                set(key, value) {
                    try {
                        if (value === null || value === undefined || value === '') {
                            localStorage.removeItem(key);
                        } else {
                            localStorage.setItem(key, value);
                        }
                    } catch (_) {}
                }
            };

            const authHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };

            function setStatus(message, type = 'default') {
                statusMessage.textContent = message;
                statusMessage.classList.remove('text-emerald-500', 'text-red-500', 'text-gray-500');
                if (type === 'error') {
                    statusMessage.classList.add('text-red-500');
                } else if (type === 'success') {
                    statusMessage.classList.add('text-emerald-500');
                } else {
                    statusMessage.classList.add('text-gray-500');
                }
            }

            function showFormFeedback(message, type = 'info') {
                formFeedback.textContent = message;
                formFeedback.classList.remove('hidden', 'text-red-500', 'text-emerald-600');
                formFeedback.classList.add(type === 'error' ? 'text-red-500' : 'text-emerald-600');
                setTimeout(() => {
                    formFeedback.classList.add('hidden');
                }, 4000);
            }

            function showAlert(message, type = 'info') {
                doctorsAlert.textContent = message;
                doctorsAlert.classList.remove('hidden', 'border-red-200', 'bg-red-50', 'text-red-700', 'border-emerald-200', 'bg-emerald-50', 'text-emerald-700', 'border-blue-200', 'bg-blue-50', 'text-blue-700');
                const palette = type === 'error'
                    ? ['border-red-200', 'bg-red-50', 'text-red-700']
                    : type === 'success'
                        ? ['border-emerald-200', 'bg-emerald-50', 'text-emerald-700']
                        : ['border-blue-200', 'bg-blue-50', 'text-blue-700'];
                doctorsAlert.classList.add(...palette);
                setTimeout(() => doctorsAlert.classList.add('hidden'), 4000);
            }

            function populateSelect(select, items, getValue, getLabel, placeholder) {
                const currentValue = select.value;
                select.innerHTML = '';
                if (placeholder) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = placeholder;
                    select.appendChild(option);
                }
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = getValue(item);
                    option.textContent = getLabel(item);
                    select.appendChild(option);
                });
                if (currentValue) {
                    const hasValue = items.some(item => String(getValue(item)) === String(currentValue));
                    if (hasValue) {
                        select.value = currentValue;
                    }
                }
            }

            async function loadMetadata() {
                setStatus('Loading reference data…');
                try {
                    const [repsRes, cityRes, specRes] = await Promise.all([
                        fetch('/api/representatives', { headers: authHeaders }),
                        fetch('/api/cities', { headers: authHeaders }),
                        fetch('/api/products/categories', { headers: authHeaders })
                    ]);

                    if (!repsRes.ok) throw new Error('Failed to load representatives');
                    if (!cityRes.ok) throw new Error('Failed to load cities');
                    if (!specRes.ok) throw new Error('Failed to load specialities');

                    const repsPayload = await repsRes.json();
                    const cityPayload = await cityRes.json();
                    const specPayload = await specRes.json();

                    state.representatives = repsPayload?.data || [];
                    state.cities = cityPayload?.data || [];
                    state.specialities = specPayload?.data?.categories
                        || specPayload?.categories
                        || specPayload?.data
                        || [];

                    const repLabel = (rep) => rep.name || rep.phone || `Rep #${rep.id}`;
                    populateSelect(formRepresentative, state.representatives, rep => rep.id, repLabel, 'Select representative');
                    populateSelect(filterRepresentative, state.representatives, rep => rep.id, repLabel, 'Select representative');

                    populateSelect(formCity, state.cities, city => city.id, city => `${city.city}${city.state ? ', ' + city.state : ''}`, 'Select city');
                    populateSelect(formSpeciality, state.specialities, spec => spec.id, spec => spec.category_name || spec.name || spec.categoryName || `Category #${spec.id}`, 'Select speciality');

                    setStatus('Reference data loaded', 'success');
                } catch (error) {
                    console.error(error);
                    setStatus(error.message || 'Failed to load reference data', 'error');
                    showAlert(error.message || 'Failed to load reference data', 'error');
                }
            }

            async function fetchDoctors() {
                if (!filterRepresentative.value) {
                    doctorsTableBody.innerHTML = '';
                    doctorsCountLabel.textContent = '0 doctors';
                    doctorsUpdatedAt.textContent = '—';
                    return;
                }

                setStatus('Loading doctors…');
                try {
                    const params = new URLSearchParams({ representativeId: filterRepresentative.value });
                    if (filterStatus.value === 'active') params.set('status', '1');
                    if (filterStatus.value === 'inactive') params.set('status', '0');

                    const res = await fetch(`/api/doctor-calls?${params.toString()}`, { headers: authHeaders });
                    if (!res.ok) {
                        const message = await res.text();
                        throw new Error(message || 'Failed to load doctors');
                    }

                    const payload = await res.json();
                    state.doctors = payload?.data?.doctors || [];
                    renderDoctors();
                    setStatus('Doctors loaded', 'success');
                } catch (error) {
                    console.error(error);
                    setStatus(error.message || 'Failed to load doctors', 'error');
                    showAlert(error.message || 'Failed to load doctors', 'error');
                }
            }

            function renderDoctors() {
                doctorsTableBody.innerHTML = '';

                if (!state.doctors.length) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 7;
                    td.className = 'px-6 py-4 text-center text-sm text-gray-500';
                    td.textContent = filterRepresentative.value ? 'No doctors found for the selected representative.' : 'Select a representative to view doctors.';
                    tr.appendChild(td);
                    doctorsTableBody.appendChild(tr);
                } else {
                    const fragment = document.createDocumentFragment();
                    state.doctors.forEach((doctor, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="px-6 py-3 text-gray-500">${index + 1}</td>
                            <td class="px-6 py-3 text-gray-900">
                                <div class="font-medium">${doctor.doctorName || '—'}</div>
                                ${doctor.address ? `<div class="text-xs text-gray-500">${doctor.address}</div>` : ''}
                            </td>
                            <td class="px-6 py-3 text-gray-500">${doctor.representativeName || '—'}</td>
                            <td class="px-6 py-3 text-gray-500">
                                <div>${doctor.cityName || '—'}</div>
                                ${doctor.state ? `<div class="text-xs text-gray-400">${doctor.state}</div>` : ''}
                            </td>
                            <td class="px-6 py-3 text-gray-500">${doctor.specialityName || '—'}</td>
                            <td class="px-6 py-3 text-center">
                                <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${doctor.status ? 'bg-emerald-50 text-emerald-600' : 'bg-gray-100 text-gray-500'}">
                                    ${doctor.status ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td class="px-6 py-3 text-right">
                                <div class="inline-flex items-center gap-2">
                                    <button type="button" class="text-indigo-600 hover:text-indigo-800 text-xs font-semibold" data-action="edit" data-id="${doctor.id}">Edit</button>
                                    <button type="button" class="text-xs font-semibold ${doctor.status ? 'text-amber-600 hover:text-amber-800' : 'text-emerald-600 hover:text-emerald-800'}" data-action="toggle" data-id="${doctor.id}">
                                        ${doctor.status ? 'Deactivate' : 'Activate'}
                                    </button>
                                </div>
                            </td>
                        `;
                        fragment.appendChild(tr);
                    });
                    doctorsTableBody.appendChild(fragment);
                }

                const count = state.doctors.length;
                doctorsCountLabel.textContent = `${count} doctor${count === 1 ? '' : 's'}`;
                doctorsUpdatedAt.textContent = new Date().toLocaleString();
            }

            function resetForm() {
                doctorIdInput.value = '';
                doctorForm.reset();
                formActive.checked = true;
                formSubmitLabel.textContent = 'Save doctor';
                formRepresentative.value = filterRepresentative.value || '';
            }

            function fillForm(doctor) {
                doctorIdInput.value = doctor.id;
                formRepresentative.value = doctor.representativeId || '';
                formDoctorName.value = doctor.doctorName || '';
                formCity.value = doctor.cityId || '';
                formSpeciality.value = doctor.specialityId || '';
                formAddress.value = doctor.address || '';
                formActive.checked = !!doctor.status;
                formSubmitLabel.textContent = 'Update doctor';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            doctorsTableBody.addEventListener('click', async (event) => {
                const actionBtn = event.target.closest('button[data-action]');
                if (!actionBtn) return;

                const doctorId = actionBtn.dataset.id;
                const doctor = state.doctors.find(d => String(d.id) === String(doctorId));
                if (!doctor) return;

                if (actionBtn.dataset.action === 'edit') {
                    fillForm(doctor);
                }

                if (actionBtn.dataset.action === 'toggle') {
                    await toggleDoctorStatus(doctor);
                }
            });

            async function toggleDoctorStatus(doctor) {
                try {
                    const res = await fetch(`/api/doctor-calls/${doctor.id}/status`, {
                        method: 'PATCH',
                        headers: authHeaders,
                        body: JSON.stringify({ active: !doctor.status })
                    });
                    if (!res.ok) {
                        const message = await res.text();
                        throw new Error(message || 'Failed to update status');
                    }
                    showAlert(`Doctor ${!doctor.status ? 'activated' : 'deactivated'} successfully`, 'success');
                    await fetchDoctors();
                } catch (error) {
                    console.error(error);
                    showAlert(error.message || 'Failed to update status', 'error');
                }
            }

            doctorForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const payload = {
                    representativeId: formRepresentative.value,
                    doctorName: formDoctorName.value.trim(),
                    cityId: formCity.value,
                    specialityId: formSpeciality.value,
                    address: formAddress.value.trim(),
                    status: formActive.checked
                };

                if (!payload.representativeId || !payload.doctorName || !payload.cityId || !payload.specialityId) {
                    showFormFeedback('Please complete all required fields.', 'error');
                    return;
                }

                const isUpdate = !!doctorIdInput.value;
                const url = isUpdate ? `/api/doctor-calls/${doctorIdInput.value}` : '/api/doctor-calls';
                const method = isUpdate ? 'PUT' : 'POST';

                try {
                    const res = await fetch(url, {
                        method,
                        headers: authHeaders,
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) {
                        const message = await res.text();
                        throw new Error(message || 'Failed to save doctor');
                    }

                    showFormFeedback(`Doctor ${isUpdate ? 'updated' : 'created'} successfully`, 'success');
                    showAlert(`Doctor ${isUpdate ? 'updated' : 'created'} successfully`, 'success');
                    resetForm();
                    await fetchDoctors();
                } catch (error) {
                    console.error(error);
                    showFormFeedback(error.message || 'Failed to save doctor', 'error');
                }
            });

            formResetBtn.addEventListener('click', () => {
                resetForm();
            });

            filterRepresentative.addEventListener('change', async () => {
                storage.set(STORAGE_KEYS.representative, filterRepresentative.value || null);
                resetForm();
                if (filterRepresentative.value) {
                    formRepresentative.value = filterRepresentative.value;
                }
                await fetchDoctors();
            });

            filterStatus.addEventListener('change', async () => {
                storage.set(STORAGE_KEYS.status, filterStatus.value);
                await fetchDoctors();
            });

            await loadMetadata();

            const storedRepresentative = storage.get(STORAGE_KEYS.representative);
            if (storedRepresentative && state.representatives.some(rep => String(rep.id) === String(storedRepresentative))) {
                filterRepresentative.value = storedRepresentative;
            } else if (!filterRepresentative.value && state.representatives.length === 1) {
                filterRepresentative.value = String(state.representatives[0].id);
                storage.set(STORAGE_KEYS.representative, filterRepresentative.value);
            }

            const storedStatus = storage.get(STORAGE_KEYS.status);
            if (storedStatus && ['all', 'active', 'inactive'].includes(storedStatus)) {
                filterStatus.value = storedStatus;
            }

            resetForm();

            if (filterRepresentative.value) {
                formRepresentative.value = filterRepresentative.value;
                await fetchDoctors();
            }
        });
    </script>
</body>
</html>
