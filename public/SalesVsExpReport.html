<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales vs Expenses Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/js/navigation.js"></script>
  <link rel="icon" href="/favicon.ico">
  <meta name="robots" content="noindex, nofollow">
  <meta name="description" content="Sales vs Expenses Report">
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="navigation-container"></div>

  <main class="container mx-auto px-4 py-8 pt-24">
    <div class="max-w-7xl mx-auto space-y-6">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-800">Sales vs Expenses Report</h1>
            <p class="text-gray-600 mt-2">Compare monthly sales against expenses.</p>
          </div>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="repSelect">Representative (optional)</label>
            <select id="repSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">All Representatives</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="fromMonth">From</label>
            <input id="fromMonth" type="month" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="toMonth">To</label>
            <input id="toMonth" type="month" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
          </div>
        </div>
        <div class="mt-4">
          <button id="loadBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">Load</button>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-3">Monthly Cards (Last 12 Months)</h2>
        <div id="monthCards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
      </div>

    <div id="expensesDetails" class="bg-white rounded-lg shadow p-6 hidden">
        <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold text-gray-800">Payments Details - <span id="detailsMonth"></span></h2>
          <button id="closeDetails" class="text-sm text-gray-600 hover:text-gray-800">Close</button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (₹)</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comments</th>
              </tr>
            </thead>
            <tbody id="expensesTbody" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>

      
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try { await NavigationLoader.loadNavigation(); } catch (_) {}
      const token = localStorage.getItem('token') || localStorage.getItem('authToken');
      if (!token) { window.location.href = '/login.html'; return; }

      // Load reps (optional filter)
      try {
        const res = await fetch('/api/users/designation/2', { headers: { 'Authorization': `Bearer ${token}` } });
        if (res.ok) {
          const json = await res.json();
          const reps = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
          const sel = document.getElementById('repSelect');
          sel.innerHTML = '<option value="">All Representatives</option>' + reps.map(r => `<option value="${r.id}">${r.name || r.phone || 'Rep ' + r.id}</option>`).join('');
        }
      } catch (_) {}

  function render(data) {
        const cards = document.getElementById('monthCards');
        if (!data.length) {
          cards.innerHTML = '<div class="col-span-full text-gray-500">No data for the selected range</div>';
        } else {
          cards.innerHTML = data.map(d => `
            <div class="border border-gray-200 rounded-lg p-3 bg-white">
              <div class="flex items-center justify-between mb-1">
                <div class="text-[12px] uppercase tracking-wide text-gray-600">${d.label}</div>
                <span class="text-[10px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">Monthly</span>
              </div>
              <div class="space-y-1">
                <div class="flex justify-between text-sm"><span class="text-gray-600">Total Sales</span><span class="font-semibold text-gray-900">₹${Number(d.sales||0).toLocaleString('en-IN')}</span></div>
                <div class="flex justify-between text-sm cursor-pointer hover:bg-gray-50 px-1 py-0.5 rounded" data-action="show-exp" data-ym="${d.ym}" data-label="${d.label}"><span class="text-gray-600 underline decoration-dotted">Total Payments</span><span class="font-semibold text-gray-900">₹${Number(d.expenses||0).toLocaleString('en-IN')}</span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-600">Product Cost</span><span class="font-semibold text-gray-900">₹${Number(d.productCost||0).toLocaleString('en-IN')}</span></div>
                <div class="border-t border-gray-300 my-1"></div>
                <div class="flex justify-between text-sm"><span class="text-gray-700 font-medium">Gross Profit</span><span class="font-semibold text-gray-900">₹${(Number(d.sales||0) - (Number(d.expenses||0) + Number(d.productCost||0))).toLocaleString('en-IN')}</span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-600">Monthly Collection</span><span class="font-semibold text-gray-900">₹${Number(d.collection||0).toLocaleString('en-IN')}</span></div>
                <div class="flex justify-between text-sm"><span class="text-gray-700 font-medium">Net Profit</span><span class="font-semibold text-gray-900">₹${(Number(d.collection||0) - (Number(d.expenses||0) + Number(d.productCost||0))).toLocaleString('en-IN')}</span></div>
              </div>
            </div>
          `).join('');
        }
  // Details table removed
      }

      function buildTimeline(from, to) {
        if (!from || !to) return [];
        const out = [];
        const [fy, fm] = from.split('-').map(n => parseInt(n, 10));
        const [ty, tm] = to.split('-').map(n => parseInt(n, 10));
        const cur = new Date(Date.UTC(fy, fm - 1, 1));
        const end = new Date(Date.UTC(ty, tm - 1, 1));
        while (cur <= end) {
          const ym = `${cur.getUTCFullYear()}-${String(cur.getUTCMonth()+1).padStart(2,'0')}`;
          const label = cur.toLocaleString('en-US', { month: 'short', year: 'numeric' });
          out.push({ ym, label });
          cur.setUTCMonth(cur.getUTCMonth() + 1);
        }
        return out;
      }

      async function load() {
        const repId = document.getElementById('repSelect').value || '';
        const paramsSales = new URLSearchParams();
        if (repId) paramsSales.set('repId', repId);
        const urlSales = '/api/orders/stats/last-6-months' + (paramsSales.toString() ? ('?' + paramsSales.toString()) : '');
        let salesData = [];
        try {
          const rs = await fetch(urlSales, { headers: { 'Authorization': `Bearer ${token}` } });
          const js = await rs.json();
          salesData = Array.isArray(js.data) ? js.data : [];
        } catch (e) { console.error('Failed to fetch sales totals', e); }

        // Build an expenses request aligned to the 12-month sales series
        const months = salesData.map(s => s.ym);
        const from = months[0];
        const to = months[months.length - 1];
        const paramsExp = new URLSearchParams();
        if (repId) paramsExp.set('repId', repId);
        if (from) paramsExp.set('from', from);
        if (to) paramsExp.set('to', to);
        const urlExp = '/api/payments/monthly-expenses' + (paramsExp.toString() ? ('?' + paramsExp.toString()) : '');
        let expData = [];
        try {
          const re = await fetch(urlExp, { headers: { 'Authorization': `Bearer ${token}` } });
          const je = await re.json();
          expData = Array.isArray(je.data) ? je.data : [];
        } catch (e) { console.error('Failed to fetch expenses', e); }

        // Fetch monthly collections (company-wide last 12 months) and map to ym
        let colMap = {};
        try {
          const rc = await fetch('/api/payments/monthly', { headers: { 'Authorization': `Bearer ${token}` } });
          const jc = await rc.json();
          const cols = Array.isArray(jc.data) ? jc.data : [];
          colMap = Object.fromEntries(cols.map(c => [c.ym, Number(c.collectionsTotal||0)]));
        } catch (e) { console.error('Failed to fetch monthly collections', e); }

        const expMap = Object.fromEntries(expData.map(e => [e.ym, Number(e.total || 0)]));
        const data = salesData.map(m => ({
          label: m.label,
          ym: m.ym,
          sales: Number(m.total || 0),
          expenses: Number(expMap[m.ym] || 0),
          productCost: Number(m.productCost || 0),
          collection: Number(colMap[m.ym] || 0)
        }));
        render(data);
      }

      document.getElementById('loadBtn').addEventListener('click', load);
      // Auto-refresh when representative selection changes to avoid showing all-users totals
      document.getElementById('repSelect').addEventListener('change', load);
  // Default: load last 12 months series from API
      load();

      // Persistent click handler for expenses details (event delegation)
      document.getElementById('monthCards').addEventListener('click', async (e) => {
        const btn = e.target.closest('[data-action="show-exp"]');
        if (!btn) return;
        const ym = btn.getAttribute('data-ym');
        const label = btn.getAttribute('data-label') || ym;
        const repId = document.getElementById('repSelect').value || '';
        const detailsBox = document.getElementById('expensesDetails');
        const detailsMonth = document.getElementById('detailsMonth');
        const tbody = document.getElementById('expensesTbody');
        detailsMonth.textContent = label;
        detailsBox.classList.remove('hidden');
        tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">Loading...</td></tr>`;
        try {
          const usp = new URLSearchParams({ ym });
          if (repId) usp.set('repId', repId);
          const res = await fetch(`/api/payments/expenses-details?${usp.toString()}`, { headers: { 'Authorization': `Bearer ${token}` } });
          const js = await res.json();
          const rows = Array.isArray(js.data) ? js.data : [];
          if (!rows.length) {
            tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">No payments for this month</td></tr>`;
          } else {
            tbody.innerHTML = rows.map(r => `
              <tr>
                <td class="px-4 py-2 text-sm text-gray-900">${r.date || ''}</td>
                <td class="px-4 py-2 text-sm text-gray-900">${r.paymentType || ''}</td>
                <td class="px-4 py-2 text-sm text-gray-900">${r.userName || ''}</td>
                <td class="px-4 py-2 text-sm text-gray-900 text-right">₹${Number(r.amount||0).toLocaleString('en-IN')}</td>
                <td class="px-4 py-2 text-sm text-gray-700">${r.comments || ''}</td>
              </tr>
            `).join('');
          }
        } catch (err) {
          tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-red-600">Failed to load details</td></tr>`;
        }
      });

      // Close handler for details
      document.getElementById('closeDetails').addEventListener('click', () => {
        document.getElementById('expensesDetails').classList.add('hidden');
      });
    });
  </script>
</body>
</html>
