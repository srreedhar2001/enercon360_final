<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Page Access - Enercon 360</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/js/navigation.js"></script>
  <script src="/js/access.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="navigation-container"></div>

  <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 mt-16">
    <div class="px-4 py-6 sm:px-0">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Page Access</h1>
          <p class="text-gray-600 mt-2">View your allowed modules by your designation</p>
        </div>
      </div>

      <div id="content" class="bg-white rounded-lg shadow p-6">
        <div class="grid grid-cols-1 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Select Designation</label>
            <select id="designationSelect" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
              <option value="">Loading...</option>
            </select>
          </div>

          <div id="matrixWrap" class="hidden">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-gray-900">Permissions</h3>
              <div class="flex items-center gap-2">
                <button id="selectAllBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-md">Select All</button>
                <button id="saveBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">Save</button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Module</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">View</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Edit</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Delete</th>
                  </tr>
                </thead>
                <tbody id="permBody" class="bg-white divide-y divide-gray-200"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
      // Enforce access for this page (use key 'page-access')
      if (window.ensurePagePermission) {
        await window.ensurePagePermission('page-access', 'view');
      } else if (window.ensurePageAccess) {
        await window.ensurePageAccess('page-access');
      }
      if (window.NavigationLoader?.loadNavigation) {
        window.NavigationLoader.loadNavigation();
        if (window.applyNavPermissions) window.applyNavPermissions();
      }

      const token = localStorage.getItem('token') || localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const CATEGORY_ORDER = { master: 1, transactions: 2, reports: 3, others: 4 };
      const FALLBACK_MODULES = [
        { key: 'dashboard', name: 'Dashboard', category: 'reports' },
        { key: 'orders', name: 'Orders', category: 'transactions' },
        { key: 'my-orders', name: 'My Orders', category: 'transactions' },
        { key: 'collections', name: 'Collections', category: 'transactions' },
        { key: 'payments', name: 'Payments', category: 'transactions' },
        { key: 'rep-sales-report', name: 'Rep Sales Report', category: 'reports' },
        { key: 'sales-vs-exp-report', name: 'Sales vs Expenses Report', category: 'reports' },
        { key: 'new-counters-report', name: 'New Counters Report', category: 'reports' },
        { key: 'counters-due', name: 'Counters Due', category: 'reports' },
        { key: 'reports', name: 'Reports', category: 'reports' },
        { key: 'work-log-report', name: 'Work Log', category: 'reports' },
        { key: 'doctor-calls', name: 'Doctor Management', category: 'reports' },
        { key: 'user-logs', name: 'User Logs', category: 'reports' },
        { key: 'users', name: 'Users', category: 'others' },
        { key: 'page-access', name: 'Page Access', category: 'others' },
        { key: 'others', name: 'Others', category: 'others' },
        { key: 'products', name: 'Products', category: 'master' },
        { key: 'counters', name: 'Counters', category: 'master' },
        { key: 'transactions', name: 'Transactions', category: 'transactions' }
      ];
      const REPORT_KEYS = new Set(['rep-sales-report','sales-vs-exp-report','new-counters-report','counters-due','dashboard','reports','work-log-report','doctor-calls','user-logs']);

      const prettify = (text = '') => text.split(/[-_]/).filter(Boolean).map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ');
      const escapeHtml = (str = '') => str.replace(/[&<>"']/g, ch => {
        switch (ch) {
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '"': return '&quot;';
          case "'": return '&#39;';
          default: return ch;
        }
      });

      function normalizeModuleEntry(entry) {
        if (!entry) return null;
        if (typeof entry === 'string') {
          return { key: entry, name: prettify(entry), category: null };
        }
        const key = (entry.key || entry.moduleKey || entry.id || '').trim();
        if (!key) return null;
        return {
          key,
          name: entry.name || entry.moduleName || prettify(key),
          category: entry.category || null
        };
      }

      function resolveCategory(mod) {
        if (mod.category) return mod.category;
        const key = mod.key.toLowerCase();
        if (REPORT_KEYS.has(key) || key.includes('report')) return 'reports';
        if (['transactions','orders','collections','payments','my-orders'].includes(key)) return 'transactions';
        if (['others','users','page-access'].includes(key)) return 'others';
        return 'master';
      }

      function normalizeModules(list) {
        const map = new Map();
        [...list, ...FALLBACK_MODULES].forEach(item => {
          const mod = normalizeModuleEntry(item);
          if (!mod) return;
          const key = mod.key;
          if (!map.has(key)) {
            map.set(key, { key, name: mod.name, category: resolveCategory(mod) });
          } else {
            const existing = map.get(key);
            if ((!existing.name || existing.name === prettify(existing.key)) && mod.name) existing.name = mod.name;
            if (!existing.category && mod.category) existing.category = resolveCategory(mod);
          }
        });
        return Array.from(map.values()).sort((a, b) => {
          const ca = CATEGORY_ORDER[a.category] || 99;
          const cb = CATEGORY_ORDER[b.category] || 99;
          if (ca !== cb) return ca - cb;
          return a.name.localeCompare(b.name);
        });
      }

      async function fetchJSON(url) {
        const res = await fetch(url, { headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` } });
        if (!res.ok) throw new Error('Request failed');
        return res.json();
      }

      // Load designations and modules
      const [desigsResp, modulesResp] = await Promise.all([
        fetchJSON('/api/access/designations'),
        fetchJSON('/api/access/modules')
      ]);

      const desigs = desigsResp.data || [];
      const rawModules = modulesResp.data || modulesResp.modules || [];
      const modules = normalizeModules(rawModules);
      const sel = document.getElementById('designationSelect');
      sel.innerHTML = '<option value="">Select designation...</option>';
      desigs.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = d.name;
        sel.appendChild(opt);
      });

      const body = document.getElementById('permBody');
      const wrap = document.getElementById('matrixWrap');
      const saveBtn = document.getElementById('saveBtn');
      const selectAllBtn = document.getElementById('selectAllBtn');

      function categoryBadge(category) {
        if (!category) return '';
        const label = prettify(category);
        return `<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-700">${escapeHtml(label)}</span>`;
      }

      function renderMatrix(perms) {
        body.innerHTML = '';
        modules.forEach(m => {
          const key = m.key;
          const display = escapeHtml(m.name || key);
          const badge = categoryBadge(m.category);
          const p = perms[key] || { view: false, edit: false, delete: false };
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-6 py-3 text-sm text-gray-900">${display}${badge}</td>
            <td class="px-6 py-3 text-center"><input type="checkbox" data-mod="${key}" data-key="view" ${p.view ? 'checked' : ''}></td>
            <td class="px-6 py-3 text-center"><input type="checkbox" data-mod="${key}" data-key="edit" ${p.edit ? 'checked' : ''}></td>
            <td class="px-6 py-3 text-center"><input type="checkbox" data-mod="${key}" data-key="delete" ${p.delete ? 'checked' : ''}></td>
          `;
          body.appendChild(tr);
        });
        wrap.classList.remove('hidden');
      }

      async function loadPerms(designationId) {
        if (!designationId) { wrap.classList.add('hidden'); return; }
        const resp = await fetchJSON(`/api/access/permissions/${designationId}`);
        renderMatrix(resp.data || {});
      }

      sel.addEventListener('change', async (e) => {
        await loadPerms(e.target.value);
      });

      saveBtn.addEventListener('click', async () => {
        const designationId = sel.value;
        if (!designationId) { alert('Select a designation'); return; }
        const inputs = body.querySelectorAll('input[type="checkbox"]');
        const perms = {};
        inputs.forEach(inp => {
          const mod = inp.getAttribute('data-mod');
          const key = inp.getAttribute('data-key');
          if (!perms[mod]) perms[mod] = { view: false, edit: false, delete: false };
          perms[mod][key] = inp.checked;
        });
        const res = await fetch(`/api/access/permissions/${designationId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ permissions: perms })
        });
        if (res.ok) alert('Permissions saved'); else alert('Failed to save');
      });

      // Select all checkboxes in the matrix
      selectAllBtn.addEventListener('click', () => {
        const inputs = body.querySelectorAll('input[type="checkbox"]');
        inputs.forEach(inp => { inp.checked = true; });
      });
    });
  </script>
</body>
</html>
